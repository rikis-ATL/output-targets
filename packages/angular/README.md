# @stencil/angular-output-target

Stencil can generate Angular component wrappers for your web components. This allows your Stencil components to be used within an Angular application. The benefits of using Stencil's component wrappers over the standard web components include:

- Angular component wrappers will be detached from change detection, preventing unnecessary repaints of your web component.
- Web component events will be converted to RxJS observables to align with Angular's @Output() and will not emit across component boundaries.
- Optionally, form control web components can be used as control value accessors with Angular's reactive forms or [ngModel].

For a detailed guide on how to add the angular output target to a project, visit: https://stenciljs.com/docs/angular.

## Installation

```bash
npm install @stencil/angular-output-target
```

## Angular Support

| **@stencil/angular-output-target** | **Angular**     |
|------------------------------------|-----------------|
| 0.10.2                             | v18.x and lower |
| 1.0.0                              | v19.x and above |

## Usage

In your `stencil.config.ts` add the following configuration to the `outputTargets` section:

```ts
import { Config } from '@stencil/core';
import { angularOutputTarget } from '@stencil/angular-output-target';

export const config: Config = {
  namespace: 'demo',
  outputTargets: [
    angularOutputTarget({
      componentCorePackage: 'component-library',
      directivesProxyFile: '../component-library-angular/src/directives/proxies.ts',
      directivesArrayFile: '../component-library-angular/src/directives/index.ts',
    }),
    {
      type: 'dist',
      esmLoaderPath: '../loader',
    },
  ],
};
```

## Config Options

| Property               | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `componentCorePackage` | The NPM package name of your Stencil component library. This package is used as a dependency for your Angular wrappers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `directivesProxyFile`  | The output file of all the component wrappers generated by the output target. This file path should point to a location within your Angular library/project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `directivesArrayFile`  | The output file of a constant of all the generated component wrapper classes. Used for easily declaring and exporting the generated components from an `NgModule`. This file path should point to a location within your Angular library/project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `valueAccessorConfigs` | The configuration object for how individual web components behave with Angular control value accessors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `excludeComponents`    | An array of tag names to exclude from generating component wrappers for. This is helpful when have a custom framework implementation of a specific component or need to extend the base component wrapper behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `outputType`           | Specifies the type of output to be generated. It can take one of the following values: <br />1. `component`: Generates all the component wrappers to be declared on an Angular module. This option is required for Stencil projects using the `dist` hydrated output.<br /> 2. `scam`: Generates a separate Angular module for each component.<br /> 3. `standalone`: Generates standalone component wrappers.<br /> Both `scam` and `standalone` options are compatible with the `dist-custom-elements` output. <br />Note: Please choose the appropriate `outputType` based on your project's requirements and the desired output structure. Defaults to `component`. |
| `customElementsDir`    | This is the directory where the custom elements are imported from when using the [Custom Elements Bundle](https://stenciljs.com/docs/custom-elements). Defaults to the `components` directory. Only applies for `outputType: "scam"` or `outputType: "standalone"`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `inlineProperties` | Experimental. When true, tries to inline the properties of components. This is required to enable Angular Language Service to type-check and show jsdocs when using the components in html-templates.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `generateIndividualComponents` | When `true`, generates individual component files that enable tree shaking. Each component gets its own file and a `components.ts` file exports all components. This allows bundlers to only include components that are actually imported. When `false` (default), generates a single monolithic proxy file. Defaults to `false` for backward compatibility. |

## Tree Shaking Support

Starting from version 1.1.0, the Angular output target supports tree shaking to reduce bundle sizes by only including components that are actually used in your application.

### Enabling Tree Shaking

To enable tree shaking, set `generateIndividualComponents: true` in your configuration:

```ts
angularOutputTarget({
  componentCorePackage: 'my-component-library',
  directivesProxyFile: '../angular-workspace/projects/component-library/src/directives/proxies.ts',
  directivesArrayFile: '../angular-workspace/projects/component-library/src/directives/index.ts',
  generateIndividualComponents: true, // Enable tree shaking
})
```

### Generated File Structure

When tree shaking is enabled, the output target generates the following structure:

```
directives/
â”œâ”€â”€ my-button.ts           # Individual component file
â”œâ”€â”€ my-checkbox.ts         # Individual component file  
â”œâ”€â”€ my-input.ts            # Individual component file
â”œâ”€â”€ components.ts          # Exports all components from individual files
â”œâ”€â”€ proxies.ts            # Re-exports from individual components (backward compatibility)
â””â”€â”€ index.ts              # DIRECTIVES array with individual imports
```

## Import Patterns and Use Cases

### Before Update (Traditional Pattern)

**Configuration:**
```ts
angularOutputTarget({
  generateIndividualComponents: false, // Default
})
```

**Generated Files:**
- Single `proxies.ts` file containing all components
- Monolithic bundle approach

**Import Pattern:**
```typescript
// All components imported together (no tree shaking)
import { MyButton, MyCheckbox, MyInput } from 'my-component-library-angular';
```

**Characteristics:**
- âŒ No tree shaking - all components bundled together
- âŒ Larger bundle sizes
- âœ… Simple import pattern
- âœ… Backward compatible

### After Update (Tree Shaking Pattern)

**Configuration:**
```ts
angularOutputTarget({
  generateIndividualComponents: true, // Enable tree shaking
})
```

**Generated Files:**
- Individual `.ts` file for each component
- `components.ts` that exports all components
- `proxies.ts` for backward compatibility

**Import Patterns (Multiple Options):**

#### Option 1: Named Imports from Main Package (Recommended)
```typescript
// Tree-shakable imports from main package
import { MyButton, MyCheckbox } from 'my-component-library-angular';
// Only MyButton and MyCheckbox will be included in bundle
```

#### Option 2: Individual File Imports
```typescript
// Direct import from individual component files
import { MyButton } from 'my-component-library-angular/directives/my-button';
import { MyCheckbox } from 'my-component-library-angular/directives/my-checkbox';
```

#### Option 3: Mixed Imports (Gradual Migration)
```typescript
// Some from main package, some from individual files
import { MyButton } from 'my-component-library-angular';
import { MyCheckbox } from 'my-component-library-angular/directives/my-checkbox';
```

**Characteristics:**
- âœ… Tree shaking enabled - only used components included
- âœ… Smaller bundle sizes
- âœ… Multiple import patterns supported
- âœ… Fully backward compatible
- âœ… Gradual migration possible

### Use Cases and Migration Strategies

#### 1. New Projects
For new projects, enable tree shaking from the start:

```ts
angularOutputTarget({
  generateIndividualComponents: true,
})
```

Use named imports from the main package:
```typescript
import { MyButton, MyInput } from 'my-component-library-angular';
```

#### 2. Existing Projects (Gradual Migration)
Enable tree shaking while maintaining existing imports:

```ts
angularOutputTarget({
  generateIndividualComponents: true, // Enable tree shaking
})
```

Existing imports continue to work but now benefit from tree shaking:
```typescript
// This now supports tree shaking automatically
import { MyButton, MyInput } from 'my-component-library-angular';
```

#### 3. Large Applications (Maximum Optimization)
For applications using only a subset of components from large libraries:

```typescript
// Only import what you use
import { MyButton } from 'my-component-library-angular';
// MyCheckbox, MyInput, and other unused components excluded from bundle
```

#### 4. Bundle Size Analysis
Enable bundle analysis to verify tree shaking effectiveness:

```bash
# Build with analysis
ng build --source-map
npx webpack-bundle-analyzer dist/main.*.js
```

### Bundle Size Impact

Tree shaking provides significant benefits, especially for large component libraries:

| Library Size | Components Used | Bundle Reduction |
|--------------|-----------------|------------------|
| 50 components | 5 components | ~80-90% |
| 100 components | 10 components | ~85-95% |
| 20 components | 15 components | ~20-30% |

### Migration Guide

#### Step 1: Enable Tree Shaking
Update your Stencil configuration:
```ts
generateIndividualComponents: true
```

#### Step 2: Rebuild Component Library
```bash
npm run build
```

#### Step 3: Verify Tree Shaking
Create a test app importing only specific components and verify bundle size.

#### Step 4: Update Imports (Optional)
Gradually migrate to more specific imports for maximum optimization:

```typescript
// Before
import { MyButton, MyCheckbox, MyInput, /* ...50 other components */ } from 'library';

// After
import { MyButton, MyInput } from 'library'; // Only import what you use
```

## Recommended Configuration for Optimal Tree Shaking

### Stencil Configuration (stencil.config.ts)

For optimal tree shaking performance, configure your Stencil project with these recommended settings:

```ts
import { Config } from '@stencil/core';
import { angularOutputTarget } from '@stencil/angular-output-target';

export const config: Config = {
  namespace: 'my-component-library',
  
  // ðŸŽ¯ Essential for modern bundling
  taskQueue: 'async',
  
  outputTargets: [
    // Angular Output Target with Tree Shaking
    angularOutputTarget({
      componentCorePackage: 'my-component-library',
      directivesProxyFile: '../my-angular-library/projects/library/src/directives/proxies.ts',
      directivesArrayFile: '../my-angular-library/projects/library/src/directives/index.ts',
      
      // ðŸŽ¯ Enable tree shaking
      generateIndividualComponents: true,
      
      // Optional: Exclude components not needed in Angular
      excludeComponents: ['my-internal-component'],
      
      // Configure for modern Angular (standalone components)
      outputType: 'standalone', // or 'scam' for module-based
    }),
    
    // ðŸŽ¯ Use dist-custom-elements for better tree shaking
    {
      type: 'dist-custom-elements',
      externalRuntime: false, // Include runtime for better compatibility
      dir: 'components',
      includeGlobalScripts: false, // Reduce bundle size
    },
    
    // Traditional dist for backward compatibility
    {
      type: 'dist',
      esmLoaderPath: '../loader',
    },
  ],
  
  // ðŸŽ¯ Optimize builds
  buildEs5: 'prod', // Only build ES5 for production
  extras: {
    enableImportInjection: true, // Better tree shaking support
  },
};
```

### Angular Library Configuration

#### 1. package.json Configuration

```json
{
  "name": "my-component-library-angular",
  "version": "1.0.0",
  
  // ðŸŽ¯ Critical for tree shaking
  "sideEffects": false,
  
  "main": "dist/fesm2022/my-component-library-angular.mjs",
  "module": "dist/fesm2022/my-component-library-angular.mjs",
  "es2020": "dist/fesm2020/my-component-library-angular.mjs",
  "esm2022": "dist/esm2022/my-component-library-angular.mjs",
  "typings": "dist/index.d.ts",
  
  // ðŸŽ¯ Support for different import patterns
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "esm2022": "./dist/esm2022/my-component-library-angular.mjs",
      "es2020": "./dist/fesm2020/my-component-library-angular.mjs",
      "default": "./dist/fesm2022/my-component-library-angular.mjs"
    },
    "./directives/*": {
      "types": "./dist/directives/*.d.ts",
      "esm2022": "./dist/esm2022/directives/*.mjs",
      "es2020": "./dist/fesm2020/directives/*.mjs",
      "default": "./dist/fesm2022/directives/*.mjs"
    }
  },
  
  "peerDependencies": {
    "@angular/common": ">=15.0.0",
    "@angular/core": ">=15.0.0"
  },
  
  "dependencies": {
    "my-component-library": "^1.0.0",
    "tslib": "^2.6.0"
  }
}
```

#### 2. ng-package.json Configuration

```json
{
  "$schema": "../../../node_modules/ng-packagr/ng-package.schema.json",
  "dest": "./dist",
  "lib": {
    "entryFile": "src/public-api.ts",
    
    // ðŸŽ¯ Enable flat module for better tree shaking
    "flatModuleFile": "my-component-library-angular",
    "umdModuleIds": {
      "my-component-library": "my-component-library"
    }
  },
  
  // ðŸŽ¯ Allow peer dependencies to be bundled for tree shaking
  "allowedNonPeerDependencies": [
    "my-component-library"
  ],
  
  // ðŸŽ¯ Optimize builds for tree shaking
  "whitelistedNonPeerDependencies": [
    "my-component-library"
  ]
}
```

#### 3. tsconfig.lib.json Configuration

```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "declaration": true,
    "declarationMap": true,
    "inlineSources": true,
    "types": [],
    
    // ðŸŽ¯ Optimize for tree shaking
    "module": "ES2022",
    "target": "ES2022",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    
    // ðŸŽ¯ Enable advanced optimizations
    "strict": true,
    "noUnusedLocals": false, // Handled by bundler
    "noUnusedParameters": false, // Handled by bundler
    "removeComments": true,
    "preserveConstEnums": false, // Better tree shaking
    "isolatedModules": true
  },
  
  "include": [
    "src/**/*"
  ],
  
  "exclude": [
    "src/test.ts",
    "src/**/*.spec.ts",
    "src/**/*.test.ts"
  ],
  
  "angularCompilerOptions": {
    "skipTemplateCodegen": true,
    "strictMetadataEmit": true,
    "enableResourceInlining": true,
    "annotationsAs": "decorators",
    "compilationMode": "partial"
  }
}
```

#### 4. angular.json Build Configuration

```json
{
  "projects": {
    "library": {
      "architect": {
        "build": {
          "builder": "@angular/build:ng-packagr",
          "options": {
            "project": "projects/library/ng-package.json"
          },
          "configurations": {
            "production": {
              "tsConfig": "projects/library/tsconfig.lib.prod.json"
            }
          }
        }
      }
    }
  }
}
```

### Consumer Application Configuration

For applications consuming the library, ensure optimal tree shaking:

#### 1. Application angular.json

```json
{
  "build": {
    "builder": "@angular/build:application",
    "options": {
      "optimization": {
        "scripts": true,
        "styles": true,
        "fonts": false
      },
      "outputHashing": "all",
      "sourceMap": false,
      "namedChunks": false,
      "aot": true,
      "extractLicenses": true,
      "vendorChunk": false,
      "buildOptimizer": true
    }
  }
}
```

#### 2. Application tsconfig.json

```json
{
  "compilerOptions": {
    "module": "ES2022",
    "target": "ES2022",
    "moduleResolution": "bundler",
    
    // ðŸŽ¯ Enable tree shaking optimizations
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "preserveSymlinks": false,
    "skipLibCheck": true,
    
    // ðŸŽ¯ Advanced optimizations
    "declaration": false,
    "removeComments": true,
    "preserveConstEnums": false
  }
}
```

### Bundle Analysis and Verification

#### 1. Add Bundle Analysis Scripts

```json
{
  "scripts": {
    "build:analyze": "ng build --source-map && npx webpack-bundle-analyzer dist/main.*.js",
    "build:stats": "ng build --stats-json",
    "bundle-size": "ng build --configuration production && bundlesize",
    "test:tree-shaking": "npm run build && node scripts/verify-tree-shaking.js"
  }
}
```

#### 2. Tree Shaking Verification Script

```typescript
// scripts/verify-tree-shaking.js
const fs = require('fs');
const path = require('path');

const distPath = path.join(__dirname, '../dist');
const mainBundle = fs.readdirSync(distPath)
  .find(file => file.startsWith('main.') && file.endsWith('.js'));

const bundleContent = fs.readFileSync(path.join(distPath, mainBundle), 'utf8');

// Check if unused components are excluded
const unusedComponents = ['MyUnusedComponent', 'AnotherUnusedComponent'];
const foundUnused = unusedComponents.filter(component => 
  bundleContent.includes(component)
);

if (foundUnused.length > 0) {
  console.error('âŒ Tree shaking failed. Found unused components:', foundUnused);
  process.exit(1);
} else {
  console.log('âœ… Tree shaking working correctly. No unused components found.');
}
```

### Performance Optimization Tips

#### 1. Lazy Loading Components

```typescript
// For large component libraries, consider lazy loading
const MyLargeComponent = () => import('my-component-library-angular/directives/my-large-component');
```

#### 2. Selective Imports in Development

```typescript
// Development: Import all for easier testing
if (environment.production) {
  import { MyButton, MyInput } from 'my-component-library-angular';
} else {
  import * as AllComponents from 'my-component-library-angular';
}
```

#### 3. Bundle Size Monitoring

```json
{
  "bundlesize": [
    {
      "path": "./dist/main.*.js",
      "maxSize": "250kb"
    }
  ]
}
```

### Common Configuration Issues

#### Issue: Tree Shaking Not Working
**Symptoms**: Bundle includes unused components
**Solutions**:
1. Ensure `sideEffects: false` in package.json
2. Verify `generateIndividualComponents: true` in Stencil config
3. Check bundler configuration supports ES modules
4. Use `dist-custom-elements` output target

#### Issue: Import Resolution Errors
**Symptoms**: Cannot resolve component imports
**Solutions**:
1. Verify exports in package.json are correct
2. Check file extensions match build output
3. Ensure TypeScript paths are properly configured

#### Issue: Large Bundle Sizes
**Symptoms**: Bundle larger than expected
**Solutions**:
1. Enable all optimization flags in angular.json
2. Use production builds with AOT compilation
3. Enable buildOptimizer and extractLicenses
4. Check for unintended global imports

### Backward Compatibility

Tree shaking is **fully backward compatible**:

- âœ… Existing imports continue to work unchanged
- âœ… No breaking changes to APIs
- âœ… Gradual migration supported
- âœ… Can be enabled/disabled via configuration
- âœ… All existing functionality preserved
